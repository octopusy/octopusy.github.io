---
layout:     post

title:     第三方支付客户端交易流程

category:   [支付]

description: 支付

keywords: pay

---

## 第三方支付客户端交易流程

目前市面上有各种形形的刷卡App，以及MPOS刷卡机，为了探秘其中的技术实现流程，我们接下来将以一款普通的蓝牙收款pos结合Android App客户端来给大家讲讲它们的工作流程是怎样的，以及支付的完整链路又是怎样的。

![mpos交易支付流程图.png](https://upload-images.jianshu.io/upload_images/4677526-e988e7e631845709.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

密钥体系：

一般pos等安全硬件上，在出厂的时候，每台pos终端会预装一个离散的传输密钥，该密钥作用主要用于解密请求后端返回的加密密钥，密钥主要存放于pos安全存储区和后台加密机中，Android客户端仅做透传作用。

客户端App上一般会设置密钥管理模块，其中包括“主密钥更新”和工作密钥更新两个模块

主密钥：主要用于解开工作密钥，充当工作密钥加解密的key

工作密钥： 工作密钥大致可分为三组，TDK密钥，TPK密钥和TAK密钥

TDK密钥：主要用于磁道数据的加解密

TPK密钥：主要用于Pin密码数据的加解密

TAK密钥：主要用于mac数据计算

加密安全方案：

磁道加密算法

D.1. 银联磁道加密算法

D.1.1. 数据源构成

D.1.1.1. 二磁道数据源

二磁道数据（35域）从结束标志“？”向左第2个字节开始，再向左取8个字节作为参与加密的二磁道中发卡方信息，记为TDB2。

D.1.1.2. 三磁道数据源

类似二磁道数据源构造方法，三磁道数据（36域，如果存在）磁道信息块构造方法如下：

三磁道数据（36域）从结束标志“？”向左第2个字节开始，再向左取8个字节作为参与加密的三磁道中发卡方信息（若不足右补足F），记为TDB3。

D.1.2. 加密方式

采用双倍长密钥TDK分别对TDB2，TDB3进行加密，将密文输出后按照对应位置替换原先的明文数据。

D.1.3. 举例

二磁道数据（37）：

1234567890123456789＝0508201781999168302

表示为:

0x12 0x34 0x56 0x78 0x90 0x12 0x34 0x56 0x78 0x9D 0x05 0x08 0x20 0x17 0x81 0x99 0x91 0x68 0x30 0x20

三磁道数据（104）：

991234567890123456789=156000000000000000000378199921600000508000000000000000000000=000000000003=0000000000

表示为:

0x99 0x12 0x34 0x56 0x78 0x90 0x12 0x34 0x56 0x78 0x9D 0x15 0x60 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03 0x78 0x19 0x99 0x21 0x60 0x00 0x00 0x50 0x80 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xD0 0x00 0x00 0x00 0x00 0x00 0x3D 0x00 0x00 0x00 0x00 0x00

则TDB2表示为：0x08 0x20 0x17 0x81 0x99 0x91 0x68 0x30

则TDB3表示为：0x00 0x00 0x00 0x3D 0x00 0x00 0x00 0x00

采用TDK对TDB2、TDB3分别进行TDES加密，加密后的磁道信息为：

ENC BLOCK1 = eTDK(0x08 0x20 0x17 0x81 0x99 0x91 0x68 0x30)

ENC BLOCK2 = eTDK(0x00 0x00 0x00 0x3D 0x00 0x00 0x00 0x00)

Mac计算

mackey明文：

DF61C75DBAAEB3CEB07F85B608153286

macblock：

0200702004C120C09813166225887854241128000000000000011211110848021000060840125840376225887854241128D14021202900102560755030303031303031383130303538343034383939303030313135367F30B0B7749FCF532600000000000000000822D0D0D000233030303130303138313030353834303438393930303031

【过程】

b) 对MAB，按每8个字节做异或（不管信息中的字符格式），如果最后不满8个字节，则添加“0X00”

07B7E6E4DB5D35E2

c) 将异或运算后的最后8个字节（RESULT BLOCK）转换成16 个HEXDECIMAL：

RESULT BLOCK = 30374237453645344442354433354532

3037423745364534

4442354433354532

d) 取前8 个字节用MAK加密，取key前16位：

B07F85B608153286

ENC BLOCK1 = DES（3037423745364534）DF61C75DBAAEB3CE = 73D3AD4C8C2A060B

e) 将加密后的结果与后16个字节异或：

73D3AD4C8C2A060B

4442354433354532

------------------------------------------------------------

TEMP BLOCK= 37919808BF1F4339

f) 用异或的结果TEMP BLOCK 再进行一次双倍长密钥算法运算。

ENC BLOCK2 = 3DES（37919808BF1F4339）DF61C75DBAAEB3CEB07F85B608153286 = E5B13004FCFD65A7

g) 将运算后的结果（ENC BLOCK2）转换成16 个HEXDECIMAL：

ENC BLOCK2 = E5B13004FCFD65A7 = 45354231333030344643464436354137

h) 取前16个字节作为MAC值。

取”4535423133303034”为MAC值。

