---
layout:     post

title:     如何快速适配AndroidP 刘海屏

category:   [Android]

description: AndroidP 刘海屏

keywords: AndroidP 刘海屏

---



## 刘海屏适配方案

智能手机发展至今，边框越做越窄，屏幕中横比越做越大。而凹口屏 (又称 "刘海屏") 更是成为各大设备厂商手中的"神兵利器"：既能让用户享受到全面屏体验，又能预留出足够空间安装感应器。目前，已经有 11 家厂商相继发布了 16 款带有 "刘海" 设计的手机，其中部分机型为 Android P Beta 设备。预计今后会有更多凹口屏设备与消费者见面。


凹口屏一方面为开发者创造了绝好的条件，展示各自应用的独特魅力；另一方面，它又凸显了适配的重要性，不论设备拥有一个还是两个屏幕缺口，采用的是 18:9 亦或是其它尺寸的屏幕，开发者需要保证应用在所有设备上都能够提供相同的用户体验。

 
<center>

![AndroidP](http://pey51suf1.bkt.clouddn.com/androidp.jpg)

△ 凹口屏设备: Essential PH-1 (左) 和华为 P20 (右)
</center>


### 凹口屏幕适配方案

随着各大设备厂商陆续跻身凹口屏大军之列，开发者应该如何正确应对，确保应用能够快速适配呢？

好消息是：即使在凹口屏设备上，大部分应用内容并不会受到影响。默认情况下，如果开发者在竖屏模式下未对状态栏设定任何特殊标志位，状态栏会根据屏幕缺口情况自行调整高度 (缺口高度 ≤ 状态栏高度)，而应用内容则会显示在状态栏以下区域；在横屏和全屏模式下，系统会在应用窗口四周保留黑边，避开在缺口区显示应用内容。

不过，为避免应用在凹口屏上出现适配问题，开发者还需注意以下几点：
不要将状态栏高度设置为固定值，否则很容易出现问题。在条件允许的情况下，可以调用 WindowInsetsCompat 获取状态栏高度；
在全屏模式下，由于系统在应用周围保留了黑边，因此画面不会占满整个屏幕，此时开发者需要谨慎考虑，窗口坐标或屏幕坐标之间作出抉择。比如说，如果您调用了 MotionEvent.getRawX/Y() 来获取触摸点触相对于屏幕原点坐标，请别忘了使用getLocationOnScreen() 将它们转换为视图坐标；
请特别注意应用在进入和退出全屏模式时的视图转换问题。

请查阅《[屏幕缺口支持指南](https://developer.android.com/guide/topics/display-cutout/#best_practices_for_display_cutout_support)》，了解适配过程中您可能遇到的问题以及相应解决方案。


### 灵活利用缺口区域

通过在缺口区域显示应用内容，尤其是视频、图片、地图或者游戏一类的内容，开发者能够显著提升应用沉浸度，为用户打造真正的全面屏体验。


<center>

![Android缺口](http://pey51suf1.bkt.clouddn.com/androidp_map.jpg)

△ 应用请求在缺口区域进行布局
</center>

开发者可以调用 Android P 中的相关 API，判断设备是否具有凹口屏，然后在获取缺口的位置信息，并管理内容在缺口区域的布局。

您可以利用全新的窗口布局属性 layoutInDisplayCutoutMode 管理应用在凹口屏幕上的布局显示。在默认情况下，只有当缺口完全包含在状态栏内时，系统才会允许应用延伸至缺口区域，否则窗口不会与缺口重叠。此外，您可以通过更改 layoutInDisplayCutoutMode 参数，让设备始终 (或绝不) 允许应用使用缺口区域。如果您希望利用到整个显示区域，而且不介意缺口位置无法显示应用内容，SHORT_EDGES 模式是个不错的选择，在该模式下，系统始终允许应用窗口延伸至缺口区域。

在适配过程中，您可调用 getDisplayCutout() 获取无显示凹口区的外边距和包围盒值，并利用这些数值判断应用内容是否与缺口重合，以及是否需要重新调整内容位置。

```
<style name="ActivityTheme">
   <item name="android.windowLayoutInDisplayCutoutMode">
     default/shortEdges/never
   </item>
</style>
```

<center>

△ 活动主题中的窗口布局属性: layoutInDisplayCutoutMode

</center>

此外，我们已经将 activity 主题中的 layoutInDisplayCutoutMode 属性往后添加到 Android 8.1 (API 27) 的设备上，您也可以在缺口区域对应用内容进行布局。不过若系统版本为 Android 8.1 或更低，设备是否具有凹口屏支持则取决于厂商。

如果应用需要针对多个 API 等级进行内容布局，您可以通过 SDK manager 下载 AndroidX 库，并使用库中的 DisplayCutoutCompat 来简化管理流程。


### 针对凹口屏测试您的应用

强烈建议您对应用的所有界面和操作进行测试，确保应用在凹口屏设备上能够流畅运行。建议您选择一款配有凹口屏的 Android P Beta 设备作为调试设备，如 Essential PH-1。

<center>

![Android缺口](http://pey51suf1.bkt.clouddn.com/androidp_system.jpg)

</center>

如果您暂时没有条件进行真机测试，您可以在非凹口屏 P 版本手机或者 Android 模拟器中，开启 "模拟具有凹口的显示屏" 的设置项，然后再进行调试。这能帮助您发现应用在凹口屏设备上运行时可能会遇到的问题，不论设备的系统版本是 Android 8.1 还是 Android P。


### 凹口屏幕全知道

Android P 中引入了对凹口屏幕的官方平台支持，同时提供了一系列 API 帮助开发者在缺口区内外对应用内容进行布局。为了保障一致性与应用兼容性，我们目前正在与设备合作伙伴展开积极合作，携手制定相关行业标准。

首先，厂商需要确保设备的凹口屏幕不会对应用造成不良影响，这涉及到以下两项关键要求：

- 在竖屏模式下，若没有设定特殊标志位，状态栏高度必须大于或等于缺口高度；
- 在全屏或横屏模式下，缺口区域必须整个落在黑色填充区内。

第二点，屏幕每条短边上缺口数量不可超过 1，即：
- 不允许一条短边上存在 2 个或 2 个以上缺口，即每台设备最多拥有 2 个屏幕缺口；
- 不允许在屏幕左侧或右侧出现缺口。

在满足以上条件的前提下，厂商可以按照各自需求，设计缺口位置和形状。


### 特殊模式

在某些运行 Android 8.1 (API 等级 27) 或更早版本的设备上，用户可以通过开启 "特殊模式"，允许系统在全屏或横屏模式下延伸应用窗口至缺口区域。用户一般可以在导航栏中找到并勾选该模式，接着系统会弹出一个确认对话框，在征得用户同意后，模式才会正式生效。

<center>

![Android缺口](http://pey51suf1.bkt.clouddn.com/androidp_landspace.jpg)

△ 提供 "特殊模式" 选项的设备允许用户将应用窗口延伸至缺口区域 (若应用支持在缺口区域显示)

</center>

如果应用的 targetSdkVersion 为 27 或更高，在必要时您可以通过更改活动主题中的layoutInDisplayCutoutMode 属性，退出特殊模式。

### 别忘了: 为长屏幕设备做好准备

在适配凹口屏的同时，您不妨考虑一下如何确保应用在长屏幕设备上 (纵横比大于或等于 18:9) 也能够正常运行，尤其是现在市面上长屏手机越来越多，而且这些设备往往同时还采用了凹口屏设计。

强烈建议您选择灵活的适配方案，确保应用不受运行设备所限，高效利用全部显示区域。您可以针对不同屏幕尺寸进行相应的兼容性测试，以确保应用在功能和视图方面都表现良好。

建议查阅《[长屏幕设备适配指南](https://mp.weixin.qq.com/s/mSD0Wup5gHZr19VPmpXD-g)》和《[如何针对长屏幕设备优化您的应用](https://mp.weixin.qq.com/s/mSD0Wup5gHZr19VPmpXD-g)》一文中列出的几项建议，进行相应开发。如果您的应用无法适应长屏幕的纵横比，您可以通过设置应用的最大支持纵横比，要求系统用黑色填充应用边缘的显示空间。

希望以上内容能对您有所帮助，让您不惧 "刘海"，只为更好体验！

《[阅读原文](https://mp.weixin.qq.com/s/mSD0Wup5gHZr19VPmpXD-g)》





